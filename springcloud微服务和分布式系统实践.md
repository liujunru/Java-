## 第1章 分布式和微服务概述

### 水平切分

所谓水平切分，就是将同一个系统部署到多台机器上

![](https://gitee.com/liujunrull/image-blob/raw/master/202210141532563.png)

这样的切分有以下几个好处。

- 简单：只需要实现一个路由算法，将请求合理地分配到各个节点即可。目前能够快速方便地实现这个功能的网关包括Nginx、Netflix Zuul和Spring Cloud Gateway等。

- 独立：每个节点都有完整的运算功能，不需要依赖其他节点，因此系统之间不需要太多的交互。

- 高可用：当出现不能工作的节点时，系统仍然可以继续运行，无须停机，因为路由算法不会给不能工作的节点分配请求。

- 可伸缩：可以随着业务的增长，增加服务节点，也可以随着业务的缩减，减少服务节点，二者都十分容易。

- 高性能：因为都是在单机内完成，不需要做外部调用，因此可以得到很高的性能。

以上就是水平切分的优势，但是这样的分法，也有很大的弊端。随着业务的发展，业务会从简单变复杂。例如，一个电商的网站，用户和业务不断膨胀，所需的产品、卖家、交易和评论业务也会日趋复杂。如果此时还将所有的业务全部集中在一套系统里开发，那么显然所有业务都会耦合到一套系统里，日后的扩展和维护会越来越困难。一方面，我们会不断地通过打包来升级系统，使得系统的稳定性和可靠性不断下降；另一方面，维护起来也不方便，例如，要升级产品业务，就需要对全部节点进行升级，而这样的升级会比较麻烦。

### 垂直切分

按照业务的维度进行拆分，将各个业务独立出来，单独开发和维护

![](https://gitee.com/liujunrull/image-blob/raw/master/202210141534473.png)

垂直切分有以下好处。

- 提高业务独立性：只要根据业务把系统划分成高内聚、低耦合的模块，就能极大地降低开发难度。

- 提高灵活性：任何一个业务发生改变，都只需要维护相关的系统，而无须将全部系统打包上线。

- 提高可维护性：独立的系统更容易发现问题。因为将业务分离出去后，发生的异常情况更容易被定位了，所以开发者和业务人员维护起来更方便了。

虽然这样的划分带来了以上诸多好处，但其存在的**弊端**也是值得我们重视的。

- 增加了系统之间的协作：系统之间往往需要协作完成任务，也就是说，系统之间是相互依赖的。例如，购买一件商品，需要买家系统提供买家信息，产品系统扣减产品库存，交易系统记录商品交易，这需要3个系统共同协作来完成。从这个角度来说，系统之间必须进行协作。现今流行的系统交互有远程过程调用（RPC）、面向服务的架构（SOA）、REST风格请求和消息机制等。

- 降低了可用性：因为系统之间存在依赖，所以任何一个系统出现问题，都会影响其他系统。例如，产品系统不可用，就无法扣减库存，也就无法进行购买产品的交易了。由此可见，可用性大大降低。

- 数据一致性难以保证：因为节点之间需要通信，而网络通信往往并不可靠，所以节点之间数据的一致性难以保证。只能通过某些方法尽量减少不一致性。

### 混合切分

![](https://gitee.com/liujunrull/image-blob/raw/master/202210141536741.png)

先是把系统按照业务维度切分到不同的服务器群里。然后，又对其中一种业务系统进行了水平切分，使得这种业务系统可以在多个节点中运行。最后，系统之间采用了交互机制进行协作。

通过其中的垂直切分，我们能够将业务分隔为独立的系统。这样就不会形成大耦合，有利于灵活的管理和简化后续的开发。而对每一个独立的业务系统又采用了水平切分，即使某个节点因为某种原因不可用，也有其他业务系统节点可以代替它。这样系统就可以变为高可用的了。这样的划分依旧不能克服系统之间大量交互和难以维护的数据一致性的问题，同时，切分节点比较多也会使实施分布式系统的硬件成本提高。实际上，无论何种划分，都不可能使得分布式系统只有优点，没有缺点。相对于耦合性和缺乏灵活性来说，大量交互和数据一致性的问题则更容易处理，因此混合划分渐渐成为主流划分方式。

### 分布式的衡量标准

- 透明性：所谓透明性，就是指一个分布式系统对外来说如同一个单机系统，使用者不需要知道其内部的实现，只需要知道其参数、功能和返回结果即可。
- 可伸缩性：当分布式系统的全部现有节点都无法满足业务膨胀的需求时，可以根据需要加入新的节点来应对业务数据的增加。当业务缩减时，又可以根据需要减少节点来达到节省资源的效果。
- 可用性：一般来说，分布式系统可全天候不间断地提供服务，即使在出现故障的情况下，也尽可能对外提供服务。因而，可以通过正常服务时间和不可用时间的比值来衡量其可用性。
- 可靠性：可靠性，主要是针对数据来说的，数据要计算正确且不丢失地存储。
- 高性能：因为有多个节点分摊请求，所以能更快地处理请求。再加上每一个节点都可以高性能地处理请求，所以分布式系统的性能比单机性能高得多。
- 一致性：因为分布式系统采用了多个节点，所以在一个业务处理中，需要多台机器协作处理数据。然而，网络延迟、丢包、不稳定性或者协作时序错乱，会造成数据的不一致或者丢失。对于一些重要的数据，如账户金额和产品库存等参数，是不允许发生错误和丢失的，所以如何保证数据的一致性和防止丢失是分布式系统的一个重要的衡量标准。

### 分布式系统的设计原则

#### CAP理论

- 一致性（consistency）：保持所有节点在同一个时刻具有相同的、逻辑一致的数据。
- 可用性（availability）：保证每个请求不管成功还是失败都有响应。
- 分区容忍性（partition tolerance）：系统中任何的信息丢失或者失败都不会影响系统的继续运作。

微服务主要追求**可用性和分区容忍性**（AP），轻一致性（C）

#### BASE理论

- 强一致性：当用户完成数据更新操作之后，任何后续线程或者其他节点都能访问到最新值。这样的设计是最友好的，即用户上一次的操作，下一次都能读到。但根据CAP原则，这种实现需要对性能做出较大的牺牲。
- 弱一致性：当用户完成数据更新操作之后，并不能保证后续线程或者其他节点马上访问到最新值。它只能通过某种方法来保证最后的一致性。

BASE理论的应用场景是**大型分布式系统**，它的核心内容是**放弃强一致性，保证系统的可用性**。因为分布式系统自身的融合和扩展就相当复杂，如果需要保证强一致性就需要额外引入许多复杂的协议，这会导致技术的复杂化，同时对性能也有影响。BASE理论则建议让数据在一段时间内不一致，从而降低技术实现的复杂性，并提高系统的性能，最后再通过某种手段使得数据达成最终一致即可。

在微服务的构建中，建议弱化通信协议的复杂性，因此推荐使用以下两种

- 包含资源API的HTTP的请求-响应和轻量级消息通信协议，尤其是现在流行的REST风格。
- 用轻量级消息总线来发布消息，如RabbitMQ或者ZeroMQ等，可以提供可靠消息的中间件
